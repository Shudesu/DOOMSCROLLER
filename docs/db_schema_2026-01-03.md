# データベース構造ドキュメント

**取得日時:** 2026/1/3 23:17:00
**データベース:** postgres://postgres:****@postgresql-aaa-u64429.vm.elestio.app:25432/postgres?sslmode=disable

---

## 目次

- [拡張機能](#拡張機能)
- [テーブル一覧](#テーブル一覧)
- [テーブル構造](#テーブル構造)
- [制約](#制約)
- [インデックス](#インデックス)
- [ビュー](#ビュー)
- [マテリアライズドビュー](#マテリアライズドビュー)
- [関数とプロシージャ](#関数とプロシージャ)
- [トリガー](#トリガー)
- [シーケンス](#シーケンス)

---

## 拡張機能

拡張機能は見つかりませんでした。

## テーブル一覧

| テーブル名 | オーナー |
|-----------|---------|
| embedding_cursor | postgres |
| favorites | postgres |
| ig_accounts | postgres |
| ig_apify_reels_raw_history | postgres |
| ig_apify_reels_raw_latest | postgres |
| ig_jobs | postgres |
| ig_post_metrics | postgres |
| ig_post_metrics_latest_table | postgres |
| owner_monthly | postgres |
| owner_stats | postgres |
| ranking_30d | postgres |

## テーブル構造

### embedding_cursor

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| name | text | NO |  |
| last_updated_at | timestamp with time zone | NO |  |
| last_ig_code | text | NO |  |
| updated_at | timestamp with time zone | NO | now() |

**主キー:**
- name

**チェック制約:**
- 2200_17334_1_not_null: name IS NOT NULL
- 2200_17334_2_not_null: last_updated_at IS NOT NULL
- 2200_17334_3_not_null: last_ig_code IS NOT NULL
- 2200_17334_4_not_null: updated_at IS NOT NULL

### favorites

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| user_id | text | NO |  |
| ig_code | text | NO |  |
| created_at | timestamp with time zone | NO | now() |

**主キー:**
- user_id, ig_code

**外部キー:**
- ig_code → ig_jobs(ig_code) [ON DELETE CASCADE, ON UPDATE NO ACTION]

**チェック制約:**
- 2200_25033_1_not_null: user_id IS NOT NULL
- 2200_25033_2_not_null: ig_code IS NOT NULL
- 2200_25033_3_not_null: created_at IS NOT NULL

### ig_accounts

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| owner_id | text | NO |  |
| username | text | YES |  |
| canonical_url | text | YES |  |
| last_collected_at | timestamp with time zone | YES |  |
| created_at | timestamp with time zone | NO | now() |
| updated_at | timestamp with time zone | NO | now() |
| error_message | text | YES |  |
| tier | text | YES |  |
| snooze_until | timestamp with time zone | YES |  |
| avg_play_last20 | numeric | YES |  |
| avg_view_last20 | numeric | YES |  |
| newest_posted_at | timestamp with time zone | YES |  |

**主キー:**
- owner_id

**チェック制約:**
- 2200_16397_1_not_null: owner_id IS NOT NULL
- 2200_16397_5_not_null: created_at IS NOT NULL
- 2200_16397_6_not_null: updated_at IS NOT NULL

### ig_apify_reels_raw_history

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| id | bigint(64) | NO | nextval('ig_apify_reels_raw_history_id_seq'::regclass) |
| ig_code | text | NO |  |
| owner_id | text | YES |  |
| owner_username | text | YES |  |
| posted_at | timestamp with time zone | YES |  |
| likes_count | integer(32) | YES |  |
| comments_count | integer(32) | YES |  |
| video_view_count | integer(32) | YES |  |
| video_play_count | integer(32) | YES |  |
| video_duration_sec | numeric | YES |  |
| payload | jsonb | NO |  |
| fetched_at | timestamp with time zone | NO | now() |
| apify_run_id | text | YES |  |
| apify_actor_id | text | YES |  |

**主キー:**
- id

**チェック制約:**
- 2200_79842_11_not_null: payload IS NOT NULL
- 2200_79842_12_not_null: fetched_at IS NOT NULL
- 2200_79842_1_not_null: id IS NOT NULL
- 2200_79842_2_not_null: ig_code IS NOT NULL

### ig_apify_reels_raw_latest

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| ig_code | text | NO |  |
| owner_id | text | YES |  |
| owner_username | text | YES |  |
| posted_at | timestamp with time zone | YES |  |
| likes_count | integer(32) | YES |  |
| comments_count | integer(32) | YES |  |
| video_view_count | integer(32) | YES |  |
| video_play_count | integer(32) | YES |  |
| video_duration_sec | numeric | YES |  |
| payload | jsonb | NO |  |
| fetched_at | timestamp with time zone | NO |  |
| apify_run_id | text | YES |  |
| apify_actor_id | text | YES |  |
| updated_at | timestamp with time zone | NO | now() |

**主キー:**
- ig_code

**チェック制約:**
- 2200_79856_10_not_null: payload IS NOT NULL
- 2200_79856_11_not_null: fetched_at IS NOT NULL
- 2200_79856_14_not_null: updated_at IS NOT NULL
- 2200_79856_1_not_null: ig_code IS NOT NULL

### ig_jobs

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| ig_code | text | NO |  |
| canonical_url | text | NO |  |
| first_seen_at | timestamp with time zone | NO | now() |
| status | text | NO | 'queued'::text |
| transcribed_at | timestamp with time zone | YES |  |
| updated_at | timestamp with time zone | YES | now() |
| audio_url | text | YES |  |
| transcript_text | text | YES |  |
| transcript_duration_sec | integer(32) | YES |  |
| error_message | text | YES |  |
| transcript_ja | text | YES |  |
| created_at | timestamp with time zone | NO | now() |
| r2_bucket | text | YES |  |
| r2_key | text | YES |  |
| audio_saved_at | timestamp with time zone | YES |  |
| apify_actor_id | text | YES |  |
| apify_run_id | text | YES |  |
| apify_status | text | YES |  |
| apify_finished_at | timestamp with time zone | YES |  |
| owner_id | text | YES |  |
| transcript_lang | text | YES |  |

**主キー:**
- ig_code

**外部キー:**
- owner_id → ig_accounts(owner_id) [ON DELETE NO ACTION, ON UPDATE NO ACTION]
- owner_id → ig_accounts(owner_id) [ON DELETE SET NULL, ON UPDATE NO ACTION]

**チェック制約:**
- 2200_16384_12_not_null: created_at IS NOT NULL
- 2200_16384_1_not_null: ig_code IS NOT NULL
- 2200_16384_2_not_null: canonical_url IS NOT NULL
- 2200_16384_3_not_null: first_seen_at IS NOT NULL
- 2200_16384_4_not_null: status IS NOT NULL

### ig_post_metrics

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| ig_code | text | NO |  |
| owner_id | text | YES |  |
| owner_username | text | YES |  |
| owner_full_name | text | YES |  |
| likes_count | integer(32) | YES |  |
| comments_count | integer(32) | YES |  |
| video_view_count | integer(32) | YES |  |
| video_play_count | integer(32) | YES |  |
| video_duration_sec | numeric | YES |  |
| posted_at | timestamp with time zone | YES |  |
| fetched_at | timestamp with time zone | NO | now() |
| updated_at | timestamp with time zone | NO | now() |
| engagement_rate | double precision(53) | YES |  |

**主キー:**
- ig_code

**チェック制約:**
- 2200_16497_11_not_null: fetched_at IS NOT NULL
- 2200_16497_12_not_null: updated_at IS NOT NULL
- 2200_16497_1_not_null: ig_code IS NOT NULL

### ig_post_metrics_latest

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| ig_code | text | YES |  |
| owner_id | text | YES |  |
| owner_username | text | YES |  |
| posted_at | timestamp with time zone | YES |  |
| likes_count | integer(32) | YES |  |
| comments_count | integer(32) | YES |  |
| video_view_count | integer(32) | YES |  |
| video_play_count | integer(32) | YES |  |
| video_duration_sec | numeric | YES |  |
| fetched_at | timestamp with time zone | YES |  |
| apify_actor_id | text | YES |  |

### ig_post_metrics_latest_table

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| ig_code | text | NO |  |
| owner_id | text | YES |  |
| owner_username | text | YES |  |
| posted_at | timestamp with time zone | YES |  |
| likes_count | integer(32) | YES |  |
| comments_count | integer(32) | YES |  |
| video_view_count | integer(32) | YES |  |
| video_play_count | integer(32) | YES |  |
| video_duration_sec | integer(32) | YES |  |
| fetched_at | timestamp with time zone | YES |  |
| apify_actor_id | text | YES |  |
| updated_at | timestamp with time zone | NO | now() |

**主キー:**
- ig_code

**チェック制約:**
- 2200_80707_12_not_null: updated_at IS NOT NULL
- 2200_80707_1_not_null: ig_code IS NOT NULL

### ig_reel_growth

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| ig_code | text | YES |  |
| owner_id | text | YES |  |
| from_at | timestamp with time zone | YES |  |
| to_at | timestamp with time zone | YES |  |
| play_diff | integer(32) | YES |  |
| view_diff | integer(32) | YES |  |
| hours_diff | numeric | YES |  |
| play_per_hour | numeric | YES |  |

### ig_reel_growth_latest

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| ig_code | text | YES |  |
| owner_id | text | YES |  |
| owner_username | text | YES |  |
| posted_at | timestamp with time zone | YES |  |
| from_at | timestamp with time zone | YES |  |
| to_at | timestamp with time zone | YES |  |
| play_diff | integer(32) | YES |  |
| view_diff | integer(32) | YES |  |
| hours_diff | numeric | YES |  |
| play_per_hour | numeric | YES |  |

### owner_monthly

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| owner_id | text | NO |  |
| month | timestamp with time zone | NO |  |
| post_count | integer(32) | YES |  |
| avg_likes | double precision(53) | YES |  |
| avg_comments | double precision(53) | YES |  |
| avg_views | double precision(53) | YES |  |
| updated_at | timestamp with time zone | YES | now() |

**主キー:**
- owner_id, month

**チェック制約:**
- 2200_17465_1_not_null: owner_id IS NOT NULL
- 2200_17465_2_not_null: month IS NOT NULL

### owner_stats

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| owner_id | text | NO |  |
| owner_username | text | YES |  |
| total_posts | integer(32) | NO |  |
| transcribed | integer(32) | NO |  |
| has_ja | integer(32) | NO |  |
| avg_likes | double precision(53) | YES |  |
| max_likes | integer(32) | YES |  |
| avg_comments | double precision(53) | YES |  |
| avg_views | double precision(53) | YES |  |
| first_collected_at | timestamp with time zone | YES |  |
| last_updated_at | timestamp with time zone | YES |  |
| updated_at | timestamp with time zone | YES | now() |
| posts_with_transcript | integer(32) | NO | 0 |
| posts_with_ja | integer(32) | NO | 0 |
| avg_plays | double precision(53) | YES |  |
| max_comments | bigint(64) | YES |  |
| max_views | bigint(64) | YES |  |
| first_post_date | timestamp with time zone | YES |  |
| last_post_date | timestamp with time zone | YES |  |

**主キー:**
- owner_id

**チェック制約:**
- 2200_17447_13_not_null: posts_with_transcript IS NOT NULL
- 2200_17447_14_not_null: posts_with_ja IS NOT NULL
- 2200_17447_1_not_null: owner_id IS NOT NULL
- 2200_17447_3_not_null: total_posts IS NOT NULL
- 2200_17447_4_not_null: transcribed IS NOT NULL
- 2200_17447_5_not_null: has_ja IS NOT NULL

### ranking_30d

| カラム名 | データ型 | NULL許可 | デフォルト値 |
|---------|---------|---------|------------|
| ig_code | text | NO |  |
| owner_id | text | YES |  |
| owner_username | text | YES |  |
| likes_count | integer(32) | YES |  |
| video_view_count | integer(32) | YES |  |
| posted_at | timestamp with time zone | YES |  |
| engagement_rate | double precision(53) | YES |  |
| total_score | double precision(53) | YES |  |
| updated_at | timestamp with time zone | YES | now() |

**主キー:**
- ig_code

**チェック制約:**
- 2200_17456_1_not_null: ig_code IS NOT NULL

---

## 制約

### 外部キー一覧

| テーブル | 制約名 | カラム | 参照先テーブル | 参照先カラム | ON DELETE | ON UPDATE |
|---------|--------|--------|--------------|------------|----------|----------|
| favorites | favorites_ig_code_fkey | ig_code | ig_jobs | ig_code | CASCADE | NO ACTION |
| ig_jobs | ig_jobs_owner_fk | owner_id | ig_accounts | owner_id | NO ACTION | NO ACTION |
| ig_jobs | ig_jobs_owner_id_fk | owner_id | ig_accounts | owner_id | SET NULL | NO ACTION |

---

## インデックス

### embedding_cursor

**embedding_cursor_pkey**

```sql
CREATE UNIQUE INDEX embedding_cursor_pkey ON public.embedding_cursor USING btree (name)
```

### favorites

**favorites_created_at_idx**

```sql
CREATE INDEX favorites_created_at_idx ON public.favorites USING btree (created_at DESC)
```

**favorites_ig_code_idx**

```sql
CREATE INDEX favorites_ig_code_idx ON public.favorites USING btree (ig_code)
```

**favorites_pkey**

```sql
CREATE UNIQUE INDEX favorites_pkey ON public.favorites USING btree (user_id, ig_code)
```

**favorites_user_id_idx**

```sql
CREATE INDEX favorites_user_id_idx ON public.favorites USING btree (user_id)
```

### ig_accounts

**ig_accounts_pkey**

```sql
CREATE UNIQUE INDEX ig_accounts_pkey ON public.ig_accounts USING btree (owner_id)
```

**ig_accounts_username_idx**

```sql
CREATE INDEX ig_accounts_username_idx ON public.ig_accounts USING btree (username)
```

### ig_apify_reels_raw_history

**ig_apify_hist_igcode_fetched_idx**

```sql
CREATE INDEX ig_apify_hist_igcode_fetched_idx ON public.ig_apify_reels_raw_history USING btree (ig_code, fetched_at DESC)
```

**ig_apify_hist_owner_fetched_idx**

```sql
CREATE INDEX ig_apify_hist_owner_fetched_idx ON public.ig_apify_reels_raw_history USING btree (owner_id, fetched_at DESC)
```

**ig_apify_hist_owner_posted_idx**

```sql
CREATE INDEX ig_apify_hist_owner_posted_idx ON public.ig_apify_reels_raw_history USING btree (owner_id, posted_at DESC)
```

**ig_apify_hist_payload_gin**

```sql
CREATE INDEX ig_apify_hist_payload_gin ON public.ig_apify_reels_raw_history USING gin (payload)
```

**ig_apify_hist_run_igcode_uniq**

```sql
CREATE UNIQUE INDEX ig_apify_hist_run_igcode_uniq ON public.ig_apify_reels_raw_history USING btree (apify_run_id, ig_code) WHERE (apify_run_id IS NOT NULL)
```

**ig_apify_reels_raw_history_igcode_fetched_at_idx**

```sql
CREATE INDEX ig_apify_reels_raw_history_igcode_fetched_at_idx ON public.ig_apify_reels_raw_history USING btree (ig_code, fetched_at DESC)
```

**ig_apify_reels_raw_history_pkey**

```sql
CREATE UNIQUE INDEX ig_apify_reels_raw_history_pkey ON public.ig_apify_reels_raw_history USING btree (id)
```

### ig_apify_reels_raw_latest

**ig_apify_latest_owner_fetched_idx**

```sql
CREATE INDEX ig_apify_latest_owner_fetched_idx ON public.ig_apify_reels_raw_latest USING btree (owner_id, fetched_at DESC)
```

**ig_apify_reels_raw_latest_pkey**

```sql
CREATE UNIQUE INDEX ig_apify_reels_raw_latest_pkey ON public.ig_apify_reels_raw_latest USING btree (ig_code)
```

### ig_jobs

**ig_jobs_created_at_idx**

```sql
CREATE INDEX ig_jobs_created_at_idx ON public.ig_jobs USING btree (created_at)
```

**ig_jobs_ig_code_covering_idx**

```sql
CREATE INDEX ig_jobs_ig_code_covering_idx ON public.ig_jobs USING btree (ig_code) INCLUDE (owner_id, canonical_url, status, transcribed_at, updated_at)
```

**ig_jobs_owner_id_idx**

```sql
CREATE INDEX ig_jobs_owner_id_idx ON public.ig_jobs USING btree (owner_id)
```

**ig_jobs_owner_status_updated_idx**

```sql
CREATE INDEX ig_jobs_owner_status_updated_idx ON public.ig_jobs USING btree (owner_id, status, updated_at)
```

**ig_jobs_pkey**

```sql
CREATE UNIQUE INDEX ig_jobs_pkey ON public.ig_jobs USING btree (ig_code)
```

**ig_jobs_status_updated_at_idx**

```sql
CREATE INDEX ig_jobs_status_updated_at_idx ON public.ig_jobs USING btree (status, updated_at NULLS FIRST)
```

### ig_post_metrics

**ig_post_metrics_engagement_rate_idx**

```sql
CREATE INDEX ig_post_metrics_engagement_rate_idx ON public.ig_post_metrics USING btree (engagement_rate DESC)
```

**ig_post_metrics_ig_code_covering_idx**

```sql
CREATE INDEX ig_post_metrics_ig_code_covering_idx ON public.ig_post_metrics USING btree (ig_code) INCLUDE (owner_id, likes_count, video_view_count, comments_count, posted_at)
```

**ig_post_metrics_owner_fetched_idx**

```sql
CREATE INDEX ig_post_metrics_owner_fetched_idx ON public.ig_post_metrics USING btree (owner_id, fetched_at DESC)
```

**ig_post_metrics_owner_ig_code_idx**

```sql
CREATE INDEX ig_post_metrics_owner_ig_code_idx ON public.ig_post_metrics USING btree (owner_id, ig_code)
```

**ig_post_metrics_owner_posted_idx**

```sql
CREATE INDEX ig_post_metrics_owner_posted_idx ON public.ig_post_metrics USING btree (owner_id, posted_at DESC)
```

**ig_post_metrics_pkey**

```sql
CREATE UNIQUE INDEX ig_post_metrics_pkey ON public.ig_post_metrics USING btree (ig_code)
```

**ig_post_metrics_posted_at_idx**

```sql
CREATE INDEX ig_post_metrics_posted_at_idx ON public.ig_post_metrics USING btree (posted_at DESC)
```

**ig_post_metrics_ranking_likes_views_idx**

```sql
CREATE INDEX ig_post_metrics_ranking_likes_views_idx ON public.ig_post_metrics USING btree (posted_at DESC, video_view_count DESC, likes_count DESC) WHERE ((likes_count IS NOT NULL) AND (video_view_count IS NOT NULL) AND (video_view_count > 0))
```

### ig_post_metrics_latest_table

**ig_post_metrics_latest_table_pkey**

```sql
CREATE UNIQUE INDEX ig_post_metrics_latest_table_pkey ON public.ig_post_metrics_latest_table USING btree (ig_code)
```

### owner_monthly

**owner_monthly_owner_month_idx**

```sql
CREATE INDEX owner_monthly_owner_month_idx ON public.owner_monthly USING btree (owner_id, month DESC)
```

**owner_monthly_pkey**

```sql
CREATE UNIQUE INDEX owner_monthly_pkey ON public.owner_monthly USING btree (owner_id, month)
```

### owner_stats

**owner_stats_last_updated_idx**

```sql
CREATE INDEX owner_stats_last_updated_idx ON public.owner_stats USING btree (last_updated_at DESC)
```

**owner_stats_pkey**

```sql
CREATE UNIQUE INDEX owner_stats_pkey ON public.owner_stats USING btree (owner_id)
```

### owner_time_series_cache

**idx_owner_time_series_cache**

```sql
CREATE UNIQUE INDEX idx_owner_time_series_cache ON public.owner_time_series_cache USING btree (owner_id, month)
```

### owner_top_posts_cache

**idx_owner_top_posts_cache_owner_rank**

```sql
CREATE INDEX idx_owner_top_posts_cache_owner_rank ON public.owner_top_posts_cache USING btree (owner_id, rank_by_likes)
```

**idx_owner_top_posts_cache_unique**

```sql
CREATE UNIQUE INDEX idx_owner_top_posts_cache_unique ON public.owner_top_posts_cache USING btree (owner_id, ig_code)
```

### owner_transcripts_cache

**idx_owner_transcripts_cache_owner**

```sql
CREATE INDEX idx_owner_transcripts_cache_owner ON public.owner_transcripts_cache USING btree (owner_id)
```

**idx_owner_transcripts_cache_unique**

```sql
CREATE UNIQUE INDEX idx_owner_transcripts_cache_unique ON public.owner_transcripts_cache USING btree (owner_id, ig_code)
```

### ranking_30d

**ranking_30d_owner_id_idx**

```sql
CREATE INDEX ranking_30d_owner_id_idx ON public.ranking_30d USING btree (owner_id)
```

**ranking_30d_pkey**

```sql
CREATE UNIQUE INDEX ranking_30d_pkey ON public.ranking_30d USING btree (ig_code)
```

**ranking_30d_score_idx**

```sql
CREATE INDEX ranking_30d_score_idx ON public.ranking_30d USING btree (total_score DESC)
```

**ranking_30d_total_score_idx**

```sql
CREATE INDEX ranking_30d_total_score_idx ON public.ranking_30d USING btree (total_score DESC)
```

---

## ビュー

### ig_post_metrics_latest

```sql
 SELECT DISTINCT ON (ig_code) ig_code,
    owner_id,
    owner_username,
    posted_at,
    likes_count,
    comments_count,
    video_view_count,
    video_play_count,
    video_duration_sec,
    fetched_at,
    apify_actor_id
   FROM ig_apify_reels_raw_history
  ORDER BY ig_code, fetched_at DESC;
```

### ig_reel_growth

```sql
 SELECT h1.ig_code,
    h1.owner_id,
    h1.fetched_at AS from_at,
    h2.fetched_at AS to_at,
    (h2.video_play_count - h1.video_play_count) AS play_diff,
    (h2.video_view_count - h1.video_view_count) AS view_diff,
    (EXTRACT(epoch FROM (h2.fetched_at - h1.fetched_at)) / (3600)::numeric) AS hours_diff,
        CASE
            WHEN (EXTRACT(epoch FROM (h2.fetched_at - h1.fetched_at)) = (0)::numeric) THEN NULL::numeric
            ELSE (((h2.video_play_count - h1.video_play_count))::numeric / (EXTRACT(epoch FROM (h2.fetched_at - h1.fetched_at)) / (3600)::numeric))
        END AS play_per_hour
   FROM (ig_apify_reels_raw_history h1
     JOIN ig_apify_reels_raw_history h2 ON (((h1.ig_code = h2.ig_code) AND (h2.fetched_at > h1.fetched_at))));
```

### ig_reel_growth_latest

```sql
 SELECT ig_code,
    owner_id,
    owner_username,
    posted_at,
    from_at,
    to_at,
    play_diff,
    view_diff,
    hours_diff,
        CASE
            WHEN (hours_diff = (0)::numeric) THEN NULL::numeric
            ELSE ((play_diff)::numeric / hours_diff)
        END AS play_per_hour
   FROM ( SELECT ig_apify_reels_raw_history.ig_code,
            ig_apify_reels_raw_history.owner_id,
            ig_apify_reels_raw_history.owner_username,
            ig_apify_reels_raw_history.posted_at,
            lag(ig_apify_reels_raw_history.fetched_at) OVER (PARTITION BY ig_apify_reels_raw_history.ig_code ORDER BY ig_apify_reels_raw_history.fetched_at) AS from_at,
            ig_apify_reels_raw_history.fetched_at AS to_at,
            (ig_apify_reels_raw_history.video_play_count - lag(ig_apify_reels_raw_history.video_play_count) OVER (PARTITION BY ig_apify_reels_raw_history.ig_code ORDER BY ig_apify_reels_raw_history.fetched_at)) AS play_diff,
            (ig_apify_reels_raw_history.video_view_count - lag(ig_apify_reels_raw_history.video_view_count) OVER (PARTITION BY ig_apify_reels_raw_history.ig_code ORDER BY ig_apify_reels_raw_history.fetched_at)) AS view_diff,
            (EXTRACT(epoch FROM (ig_apify_reels_raw_history.fetched_at - lag(ig_apify_reels_raw_history.fetched_at) OVER (PARTITION BY ig_apify_reels_raw_history.ig_code ORDER BY ig_apify_reels_raw_history.fetched_at))) / (3600)::numeric) AS hours_diff
           FROM ig_apify_reels_raw_history) t
  WHERE (from_at IS NOT NULL);
```

---

## マテリアライズドビュー

### owner_time_series_cache

- インデックス有無: あり
- データ投入済み: はい

**定義:**

```sql
 SELECT owner_id,
    date_trunc('month'::text, posted_at) AS month,
    count(*) AS post_count,
    avg(likes_count) AS avg_likes,
    avg(comments_count) AS avg_comments,
    avg(video_view_count) AS avg_views
   FROM ig_post_metrics
  WHERE posted_at IS NOT NULL
  GROUP BY owner_id, (date_trunc('month'::text, posted_at));
```

### owner_top_posts_cache

- インデックス有無: あり
- データ投入済み: はい

**定義:**

```sql
 SELECT m.owner_id,
    m.ig_code,
    m.likes_count,
    m.comments_count,
    m.video_view_count,
    m.posted_at,
        CASE
            WHEN j.transcript_text IS NOT NULL THEN true
            ELSE false
        END AS has_transcript,
        CASE
            WHEN j.transcript_ja IS NOT NULL THEN true
            ELSE false
        END AS has_ja,
    row_number() OVER (PARTITION BY m.owner_id ORDER BY m.likes_count DESC NULLS LAST) AS rank_by_likes
   FROM ig_post_metrics m
     LEFT JOIN ig_jobs j ON j.ig_code = m.ig_code
  WHERE m.likes_count IS NOT NULL;
```

### owner_transcripts_cache

- インデックス有無: あり
- データ投入済み: はい

**定義:**

```sql
 SELECT m.owner_id,
    j.transcript_text,
    j.ig_code
   FROM ig_jobs j
     JOIN ig_post_metrics m ON m.ig_code = j.ig_code
  WHERE j.transcript_text IS NOT NULL AND j.transcript_text <> ''::text;
```

---

## 関数とプロシージャ

### refresh_analytics_cache

- 種類: function
- 引数: 
- 戻り値型: void

**定義:**

```sql
CREATE OR REPLACE FUNCTION public.refresh_analytics_cache()
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY owner_time_series_cache;
  REFRESH MATERIALIZED VIEW CONCURRENTLY owner_top_posts_cache;
  REFRESH MATERIALIZED VIEW CONCURRENTLY owner_transcripts_cache;
END;
$function$

```

---

## トリガー

トリガーは見つかりませんでした。

---

## シーケンス

| シーケンス名 | データ型 | 開始値 | 最小値 | 最大値 | 増分 | サイクル |
|------------|---------|--------|--------|--------|------|---------|
| ig_apify_reels_raw_history_id_seq | bigint | 1 | 1 | 9223372036854775807 | 1 | NO |

---

*このドキュメントは 2026/1/3 23:17:00 に自動生成されました。*